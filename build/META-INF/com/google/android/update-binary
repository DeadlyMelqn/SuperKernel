#!/sbin/sh

OUTFD=$2
ZIP=$3

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}

cd /tmp
rm -rf tkkg1994
mkdir tkkg1994
cd tkkg1994
unzip -o "$ZIP"

getprop ro.boot.bootloader >> BLmodel

ui_print " ";
ui_print " - mounting system partition"
mount /system

ui_print " - mounting data partition"
mount /data

ui_print " - Installing SuperStock-Kernel"

if grep -q G935F BLmodel; then
	cat hero2lte-eur.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G935F kernel"
else if grep -q G930F BLmodel; then
	cat herolte-eur.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G930F kernel"
else if grep -q G930K BLmodel; then
	cat herolte-ktt.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G930K kernel"
else if grep -q G930L BLmodel; then
	cat herolte-lgt.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G930L kernel"
else if grep -q G930S BLmodel; then
	cat herolte-skt.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G930S kernel"
else if grep -q G930W8 BLmodel; then
	cat herolte-eur.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G930W8 kernel"
else if grep -q G935K BLmodel; then
	cat hero2lte-ktt.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G935K kernel"
else if grep -q G935L BLmodel; then
	cat hero2lte-lgt.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G935L kernel"
else if grep -q G935S BLmodel; then
	cat hero2lte-skt.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G935S kernel"
else if grep -q G935W8 BLmodel; then
	cat hero2lte-eur.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print " - Flashing G935W8 kernel"
else
	echo "Not a supported model. Dont flash any kernel!"
	ui_print " - Model not support, no kernel flashed"
fi;
fi;
fi;
fi;
fi;
fi;
fi;
fi;
fi;
fi;

ui_print " - removing wrong build.prop entries"

sed -i /timaversion/d /system/build.prop
sed -i /security.mdpp.mass/d /system/build.prop
sed -i /ro.hardware.keystore/d /system/build.prop

ui_print " - setting right fingerprint files"

rm -rf /system/app/TuiService /system/app/mcRegistry
rm -f /system/vendor/lib/libsecure_storage.so
rm -f /system/vendor/lib/libsecure_storage_jni.so
rm -f /system/vendor/lib64/libsecure_storage.so
rm -f /system/vendor/lib64/libsecure_storage_jni.so
mkdir /system/etc/init.d

cd
cd /tmp/tkkg1994
mv -f mcRegistry /system/app
mv -f vendor/lib/libsecure_storage.so /system/vendor/lib/libsecure_storage.so
mv -f vendor/lib/libsecure_storage_jni.so /system/vendor/lib/libsecure_storage_jni.so
mv -f vendor/lib64/libsecure_storage.so /system/vendor/lib64/libsecure_storage.so
mv -f vendor/lib64/libsecure_storage_jni.so /system/vendor/lib64/libsecure_storage_jni.so
mv -f files/wakelock.sh /system/etc/init.d
mv -f files/busybox /system/xbin
mv -f files/sqlite3 /system/xbin
mv -f files/zip /system/xbin

ui_print " - setting permissions"

chmod 0644 /system/vendor/lib/libsecure_storage.so
chmod 0644 /system/vendor/lib/libsecure_storage_jni.so
chmod 0644 /system/vendor/lib64/libsecure_storage.so
chmod 0644 /system/vendor/lib64/libsecure_storage_jni.so
chmod 0755 /system/app/mcRegistry
chmod 0644 /system/app/mcRegistry/*.tlbin
chmod 0755 /system/etc/init.d/wakelock.sh
chmod 0755 /system/xbin/busybox
chmod 0755 /system/xbin/sqlite3
chmod 0755 /system/xbin/zip

ui_print " - unmounting partition /data"
umount /data > /dev/null 2>&1

ui_print " - unmounting partition /system"
umount /system > /dev/null 2>&1

ui_print " "
ui_print "finished"
rm -rf /tmp/tkkg1994
sync
